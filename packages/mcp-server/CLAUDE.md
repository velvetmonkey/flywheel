# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

Flywheel MCP server exposes Obsidian vault intelligence to Claude Code. It parses markdown files directly to provide graph queries, wikilink suggestions, and vault health checks.

**First-to-market** in: graph intelligence, wikilink services, vault health for Obsidian MCP servers.

Tools across 9 categories: Graph, Wikilinks, Health, Search, Deep Graph, Structure, Tasks, Frontmatter, Temporal.

## Commands

```bash
npm install          # Install dependencies
npm run dev          # Run server in development (requires PROJECT_PATH env var)
npm run build        # Build to dist/ for distribution
npm run inspect      # Test with MCP inspector
npm test             # Run tests
```

To run with a vault:

```bash
PROJECT_PATH=/path/to/vault npm run dev
```

## Architecture

```
src/
â”œâ”€â”€ index.ts                 # MCP server entry, tool registration
â”œâ”€â”€ core/
â”‚   â”œâ”€â”€ vault.ts            # Vault scanner, file discovery
â”‚   â”œâ”€â”€ parser.ts           # Markdown parser (frontmatter, links, tags)
â”‚   â”œâ”€â”€ graph.ts            # In-memory link graph + VaultIndex
â”‚   â””â”€â”€ types.ts            # Shared TypeScript types
â”œâ”€â”€ tools/
â”‚   â”œâ”€â”€ graph.ts            # Backlinks, forward links, orphans, hubs
â”‚   â”œâ”€â”€ graph-analysis.ts   # Link paths, neighbors, bidirectional, dead ends
â”‚   â”œâ”€â”€ wikilinks.ts        # Suggest, validate, broken links, unlinked mentions
â”‚   â”œâ”€â”€ health.ts           # Vault stats, folder structure, activity
â”‚   â”œâ”€â”€ query.ts            # Search notes, recent, stale, date ranges
â”‚   â”œâ”€â”€ structure.ts        # Headings, sections, note structure
â”‚   â”œâ”€â”€ tasks.ts            # Task extraction, due dates
â”‚   â”œâ”€â”€ frontmatter.ts      # Schema, field values, inconsistencies
â”‚   â””â”€â”€ temporal.ts         # Contemporaneous notes, metadata
```

**Key design decisions**:

- **File-first**: parses markdown directly, no database, works offline
- **Eager loading**: full vault scan on startup (fine for (5000 notes)
- **In-memory graph**: VaultIndex holds notes, backlinks, entities, tags
- **Privacy by design**: returns structure/metadata, not content
- **No Dataview dependency**: Dataview requires Obsidian internals; we use native queries instead

## MCP Tool Development Rules

When creating new MCP tools:

1. **Always use MAX_LIMIT cap** - Import from `core/constants.ts` and cap all limit parameters:
   ```typescript
   import { MAX_LIMIT } from '../core/constants.js';

   // In tool handler:
   async ({ limit: requestedLimit = 50 }) => {
     const limit = Math.min(requestedLimit, MAX_LIMIT);
     // ...
   }
   ```

2. **Support pagination** - Return `total_count` and `returned_count` so clients know there's more data. Include `offset` parameter for pagination.

3. **Default limits** - Use sensible defaults (typically 50, or 25 for heavier operations like tasks)

**Dependencies**:

- `@modelcontextprotocol/sdk` - MCP protocol handling
- `gray-matter` - YAML frontmatter parsing
- `zod` - schema validation

**Environment**: `PROJECT_PATH` environment variable points to the vault directory. If not set, defaults to current working directory.

## Development

Quick commands:

```bash
npx tsc --noEmit                    # Type check
npx @modelcontextprotocol/inspector npx tsx src/index.ts  # Interactive testing
```

## Key Types

```typescript
interface VaultNote {
  path: string;              // Relative to vault root
  title: string;             // Filename without .md
  aliases: string[];         // From frontmatter
  frontmatter: Record<string, unknown>;
  outlinks: OutLink[];       // [[wikilinks]] this note contains
  tags: string[];            // #tags in content + frontmatter
  modified: Date;
}

interface VaultIndex {
  notes: Map<string, VaultNote>;
  backlinks: Map<string, Set<string>>;
  entities: Map<string, string>;
  tags: Map<string, Set<string>>;
}
```

## Related

See [Flywheel](https://github.com/velvetmonkey/flywheel) - Main project repository.


<claude-mem-context)
# Recent Activity

(!-- This section is auto-generated by claude-mem. Edit content outside the tags. --)

### Jan 11, 2026

| ID | Time | T | Title | Read |
|----|------|---|-------|------|
| #390 | 10:33 PM | ðŸ”µ | MCP Server Package README Reviewed | ~342 |
| #218 | 3:05 PM | âš–ï¸ | Explore agent compiled comprehensive reference map of all skill/agent/command mentions | ~555 |
| #200 | 3:01 PM | ðŸ”µ | MCP server README is focused on query tools and infrastructure | ~365 |
(/claude-mem-context)

<claude-mem-context>
# Recent Activity

<!-- This section is auto-generated by claude-mem. Edit content outside the tags. -->

### Feb 1, 2026

| ID | Time | T | Title | Read |
|----|------|---|-------|------|
| #4723 | 1:28 PM | ðŸ”µ | Flywheel MCP-Server Package Configuration | ~285 |
</claude-mem-context>