# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

Flywheel MCP server exposes Obsidian vault intelligence to Claude Code. It parses markdown files directly to provide graph queries, wikilink suggestions, and vault health checks.

**First-to-market** in: graph intelligence, wikilink services, vault health for Obsidian MCP servers.

Tools across 9 categories: Graph, Wikilinks, Health, Search, Deep Graph, Structure, Tasks, Frontmatter, Temporal.

## Commands

```bash
npm install          # Install dependencies
npm run dev          # Run server in development (requires PROJECT_PATH env var)
npm run build        # Build to dist/ for distribution
npm run inspect      # Test with MCP inspector
npm test             # Run tests
```

To run with a vault:

```bash
PROJECT_PATH=/path/to/vault npm run dev
```

## Architecture

```
src/
â”œâ”€â”€ index.ts                 # MCP server entry, tool registration
â”œâ”€â”€ core/
â”‚   â”œâ”€â”€ vault.ts            # Vault scanner, file discovery
â”‚   â”œâ”€â”€ parser.ts           # Markdown parser (frontmatter, links, tags)
â”‚   â”œâ”€â”€ graph.ts            # In-memory link graph + VaultIndex
â”‚   â””â”€â”€ types.ts            # Shared TypeScript types
â”œâ”€â”€ tools/
â”‚   â”œâ”€â”€ graph.ts            # Backlinks, forward links, orphans, hubs
â”‚   â”œâ”€â”€ graph-analysis.ts   # Link paths, neighbors, bidirectional, dead ends
â”‚   â”œâ”€â”€ wikilinks.ts        # Suggest, validate, broken links, unlinked mentions
â”‚   â”œâ”€â”€ health.ts           # Vault stats, folder structure, activity
â”‚   â”œâ”€â”€ query.ts            # Search notes, recent, stale, date ranges
â”‚   â”œâ”€â”€ structure.ts        # Headings, sections, note structure
â”‚   â”œâ”€â”€ tasks.ts            # Task extraction, due dates
â”‚   â”œâ”€â”€ frontmatter.ts      # Schema, field values, inconsistencies
â”‚   â””â”€â”€ temporal.ts         # Contemporaneous notes, metadata
```

**Key design decisions**:

- **File-first**: parses markdown directly, no database, works offline
- **Eager loading**: full vault scan on startup (fine for (5000 notes)
- **In-memory graph**: VaultIndex holds notes, backlinks, entities, tags
- **Privacy by design**: returns structure/metadata, not content
- **No Dataview dependency**: Dataview requires Obsidian internals; we use native queries instead

## MCP Tool Development Rules

When creating new MCP tools:

1. **Always use MAX_LIMIT cap** - Import from `core/constants.ts` and cap all limit parameters:
   ```typescript
   import { MAX_LIMIT } from '../core/constants.js';

   // In tool handler:
   async ({ limit: requestedLimit = 50 }) => {
     const limit = Math.min(requestedLimit, MAX_LIMIT);
     // ...
   }
   ```

2. **Support pagination** - Return `total_count` and `returned_count` so clients know there's more data. Include `offset` parameter for pagination.

3. **Default limits** - Use sensible defaults (typically 50, or 25 for heavier operations like tasks)

**Dependencies**:

- `@modelcontextprotocol/sdk` - MCP protocol handling
- `gray-matter` - YAML frontmatter parsing
- `zod` - schema validation

**Environment**: `PROJECT_PATH` environment variable points to the vault directory. If not set, defaults to current working directory.

## Development

Quick commands:

```bash
npx tsc --noEmit                    # Type check
npx @modelcontextprotocol/inspector npx tsx src/index.ts  # Interactive testing
```

## Key Types

```typescript
interface VaultNote {
  path: string;              // Relative to vault root
  title: string;             // Filename without .md
  aliases: string[];         // From frontmatter
  frontmatter: Record<string, unknown>;
  outlinks: OutLink[];       // [[wikilinks]] this note contains
  tags: string[];            // #tags in content + frontmatter
  modified: Date;
}

interface VaultIndex {
  notes: Map<string, VaultNote>;
  backlinks: Map<string, Set<string>>;
  entities: Map<string, string>;
  tags: Map<string, Set<string>>;
}
```

## Related

See [Flywheel](https://github.com/velvetmonkey/flywheel) - Main project repository.


<claude-mem-context)
# Recent Activity

(!-- This section is auto-generated by claude-mem. Edit content outside the tags. --)

### Jan 11, 2026

| ID | Time | T | Title | Read |
|----|------|---|-------|------|
| #390 | 10:33 PM | ðŸ”µ | MCP Server Package README Reviewed | ~342 |
| #218 | 3:05 PM | âš–ï¸ | Explore agent compiled comprehensive reference map of all skill/agent/command mentions | ~555 |
| #200 | 3:01 PM | ðŸ”µ | MCP server README is focused on query tools and infrastructure | ~365 |
(/claude-mem-context)

<claude-mem-context>
# Recent Activity

<!-- This section is auto-generated by claude-mem. Edit content outside the tags. -->

### Jan 29, 2026

| ID | Time | T | Title | Read |
|----|------|---|-------|------|
| #844 | 9:04 PM | âœ… | Committed Flywheel license change to git repository | ~324 |
| #842 | " | âœ… | Flywheel build verification successful after license change | ~317 |
| #839 | 9:03 PM | âœ… | Updated Flywheel MCP server package.json license field to Apache-2.0 | ~312 |

### Jan 30, 2026

| ID | Time | T | Title | Read |
|----|------|---|-------|------|
| #2122 | 6:56 PM | ðŸŸ£ | Committed WSL Polling Mode Fix to Repository | ~367 |
| #2117 | 6:55 PM | âœ… | Bumped MCP Server Package Version to 1.27.4 | ~263 |
| #2115 | " | ðŸ”µ | MCP Server Package Uses Chokidar for File Watching | ~330 |
| #2087 | 5:53 PM | âœ… | Version 1.27.3 Committed with Token Savings Audit and File Watching Changes | ~431 |
| #2078 | 5:04 PM | âœ… | Token Savings Audit Modified 11 Files Across Codebase | ~375 |
| #2075 | 5:03 PM | âœ… | MCP Server Package Version Bumped to 1.27.3 | ~250 |
| #2073 | " | âœ… | MCP Server Package Description Updated to Remove 100x Claim | ~285 |
| #2072 | 5:02 PM | ðŸ”µ | MCP Server Package.json Contains Duplicate 100x Token Savings Claim | ~263 |
| #2007 | 4:23 PM | âœ… | Version bump committed to main branch | ~249 |
| #2006 | " | âœ… | Version bumped to 1.27.1 for documentation cleanup release | ~253 |
| #2003 | " | ðŸ”µ | Git status shows documentation cleanup changes across three files | ~307 |

### Jan 31, 2026

| ID | Time | T | Title | Read |
|----|------|---|-------|------|
| #3527 | 4:52 PM | âœ… | Flywheel MCP version bumped to 1.27.10 | ~268 |
| #3443 | 4:12 PM | ðŸ”´ | Verified flywheel package current version v1.27.8 | ~182 |
| #3444 | " | ðŸ”´ | Deployed flywheel v1.27.9 with ROADMAP market opportunities documentation | ~301 |
| #3423 | 4:04 PM | âœ… | Bumped Flywheel Package Version to 1.27.9 | ~223 |
| #3421 | " | ðŸ”µ | Verified Flywheel Package Version is 1.27.8 | ~171 |
| #2844 | 3:38 AM | ðŸ”µ | Vault-Core Dependency Analysis Across Flywheel Ecosystem | ~366 |
| #2843 | " | ðŸ”µ | Flywheel MCP Server Package Configuration | ~327 |
| #2756 | 2:40 AM | âœ… | Bumped flywheel to v1.27.7 and pushed to origin | ~322 |
</claude-mem-context>